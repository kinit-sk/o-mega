Code copied and slightly modified from: https://github.com/g8a9/ferret